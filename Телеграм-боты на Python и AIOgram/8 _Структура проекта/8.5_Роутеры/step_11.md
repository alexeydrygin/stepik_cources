## Роутеры
-------

Хэндлеры нужно зарегистрировать в диспетчере - корневом роутере, как мы выяснили из исходников `aiogram` (ну, и в [документации](https://docs.aiogram.dev/en/dev-3.x/dispatcher/dispatcher.html#dispatcher) об этом тоже написано). Как следует из экспериментов этого урока - мы не можем просто импортировать диспетчер в модули с хэндлерами и зарегистрировать в нем хэндлеры. Этого недостаточно. Надо еще как-то в исполняемом файле узнать, что хэндлеры вообще есть, а значит, исполнить код с ними, а это значит, что из них надо что-то импортировать. А импортировать, кроме самих хэндлеров, пока нечего.

Собственно, разработчики `aiogram` тоже столкнулись со всей этой ситуацией и придумали довольно неплохой выход. А давайте у нас будет возможность от корневого роутера (диспетчера) делать ответвления - другие роутеры. В этих роутерах регистрировать хэндлеры (или еще роутеры), а затем присоединять их к диспетчеру. И чтобы это не казалось костыльной попыткой выкрутиться, типа, у нас же не какие-то бесполезные переменные, у нас же РОУТЕРЫ! Добавим роутерам полезный функционал.

Еще немного теории и затем к практике. В документации есть такая картинка:

![](https://ucarecdn.com/be1d8459-d092-4965-b082-ab298564232b/-/preview/-/enhance/77/)

Из нее понятно, что роутеры цепляются к диспетчеру (корневому роутеру) или к другим роутерам. И хэндлеры цепляются к роутерам или к диспетчеру. То есть можно выстраивать древовидную структуру, где в конечном итоге все сходится к диспетчеру.

Там же в документации есть и еще одна картинка, демонстрирующая как именно будут двигаться апдейты по такому дереву из роутеров и хэндлеров.

![](https://ucarecdn.com/ea9d1686-24b1-4b61-b628-35e562c8afb4/-/preview/-/enhance/82/)

Движение апдейта происходит только в одну сторону. Сначала он попадает в корневой роутер (диспетчер). Если фильтры не пропускают его в какой-то из хэндлеров диспетчера - идет передача апдейта в первый роутер. Там тоже фильтры перед хэндлерами. Если и они не пропускают апдейт - он попадает в третий роутер и так далее. Либо пока какой-то из хэндлеров, наконец, не заберет апдейт, либо пока роутеры и фильтры не кончатся.

Таким образом, можно делать и роутеры для одного-двух хэндлеров, и роутеры для группы хэндлеров одного модуля, и роутеры для хэндлеров всего модуля, и роутеры пакета и даже роутеры пакета пакетов :) А полезно это может быть, например, тем, что можно на сами роутеры вешать фильтры. То есть, если мы хотим, чтобы некоторая группа хэндлеров была доступна только администратору бота, то нам не придется на каждый хэндлер группы вешать фильтр проверки на админа. Достаточно повесить фильтр на роутер, а хэндлеры зарегистрировать в этом роутере.

Если пока вам это все кажется не очень понятным, то, надеюсь, помогут практические примеры. Сейчас мы с вами перепишем модульного эхо-бота с применением роутеров так, что он, наконец, заработает корректно.