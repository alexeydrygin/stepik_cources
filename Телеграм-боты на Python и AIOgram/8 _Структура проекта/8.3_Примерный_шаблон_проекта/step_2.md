## Что вообще происходит у бота под капотом?
-----------------------------------------

А теперь подумаем, какие слои могут быть у телеграм бота. Что вообще делает бот, с точки зрения его внутреннего устройства? Давайте думать вместе.

*   Бот ждет апдейты от серверов телеграм. Это некоторый главный процесс, который запущен постоянно, и его задача просто получать апдейты, не суть важно каким способом. Через long polling или webhook - как настроите.
    
*   Но прежде чем бот войдет в режим ожидания апдейтов - его нужно сконфигурировать, то есть предварительно настроить, а значит, где-то должны храниться данные и методы для конфигурации бота. Настроили, запустили, ждем апдейты.
    
*   Когда пришел апдейт - нужно решить, что с ним делать - требуются ли какие-то предварительные действия или можно сразу отправлять его на обработчики. Это слой middleware.
    
*   Апдейт прошел слой middleware и отправился в сторону обработчиков, значит, где-то нужно хранить обработчики. Причем они тоже могут разделяться на группы. Хэндлеры для обычных пользователей, хэндлеры для платных пользователей, хэндлеры для админов и т.п.
    
*   В обработчиках есть фильтры, через которые должны проходить апдейты, чтобы обработчики срабатывали. Если есть какие-то кастомные фильтры - их тоже имеет смысл вынести отдельно.
    
*   Когда срабатывает обработчик на апдейт, прошедший через фильтры - может запускаться какая-то бизнес-логика. Ее тоже нужно хранить отдельно.
    
*   В процессе работы бизнес-логики, да и не только, часто нужно будет обращаться за какими-то данными - или из внешних сервисов, или из базы данных бота, то есть отдельно надо вынести работу с БД и работу с внешними API.
    
*   При взаимодействии с пользователем, бот должен будет пользователю что-то отвечать, то есть где-то нужно хранить возможные ответы, причем, иногда на разных языках.
    
*   Сообщения от бота могут быть не только и не столько в формате текста, очень часто это будут кнопки (обычные или инлайн), соответственно,  нужно хранить клавиатуры с кнопками или методы их формирования на лету.
    
*   При взаимодействии пользователей с ботом, они могут находиться в разных состояниях, требующих разной реакции бота. Состояния будем рассматривать подробно, когда дойдем до машины состояний, сейчас остановимся на том, что логику состояний тоже нужно выносить отдельно.
    
*   Отдельно еще, бывает, выносят тесты, хотя почему-то среди разработчиков ботов это не частая практика. Мы, кстати, в этом курсе, думаю, тоже не будем заморачиваться. А может и будем, пока не знаю :)
    
*   Также нужны обработчики исключений, которые обязательно будут возникать при работе бота. Нам тоже нужно будет их отлавливать и обрабатывать, чтобы бот продолжал работать, а не падал, оставляя пользователей в недоумении.
    
*   Ну, и, наверное, нужно еще, на всякий случай, завести слой с какими-то вспомогательными функциями - утилитами, которые могут понадобиться в процессе работы бота, но по логике никуда больше не подходят.
    

Если подвести небольшой итог, в шаблоне имеет смысл заложить следующие разделы:

*   **Конфигурационные данные**
*   **Точка входа (запуск бота)**
*   **Middleware**
*   **Фильтры**
*   **Хэндлеры**
*   **Бизнес-логика**
*   **Взаимодействие с БД**
*   **Взаимодействие с внешними API**
*   **Лексикон бота**
*   **Клавиатуры**
*   **Состояния**
*   **Тесты**
*   **Обработчики ошибок**
*   **Утилиты**

Если что-то забыл - поправляйте, курс от этого только выиграет.

Теперь, когда мы представляем, что нам вообще от бота нужно - можно накидать примерный шаблон проекта.