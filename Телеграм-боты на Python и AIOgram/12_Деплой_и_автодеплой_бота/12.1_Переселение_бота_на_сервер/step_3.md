## Настройка удаленного сервера
----------------------------

Итак, сервер создан. Публичная часть SSH ключа для доступа добавлена. Давайте подключимся к серверу по SSH и проведем первичные настройки.

Запускаем терминал на компьютере, с которого будем управлять сервером. И выполняем команду (вместо IP-адреса моего сервера вбивайте свой):

    ssh root@188.124.51.136

Посмотреть IP-адрес сервера всегда можно в панели управления вашими серверами у вашего провайдера. В частности, у [Selectel](https://selectel.ru/?utm_source=stepik.org&utm_medium=referral&utm_campaign=help_cloud_sharedline_0123_courseAIOgram) это можно сделать, если слева выбрать **Cloud platform**, а затем **Servers**.

![](https://ucarecdn.com/20dcec8d-69a6-4be0-82aa-a6c23ae33d4e/-/preview/-/enhance/84/)

Нужно будет подтвердить, что вы соединяетесь с тем самым сервером, ответив "yes" на вопрос в терминале типа:

    The authenticity of host '188.124.51.136 (188.124.51.136)' can't be established.
    ECDSA key fingerprint is SHA256:Ae992nachSmuYHi8hq+j0U8NxzjcwIfX84tv6S3bvYA.
    Are you sure you want to continue connecting (yes/no/[fingerprint])?

Далее сервер вас поприветствует

    Warning: Permanently added '188.124.51.136' (ECDSA) to the list of known hosts.
    Welcome to Ubuntu 22.04.1 LTS (GNU/Linux 5.15.0-58-generic x86_64)
    
     * Documentation:  https://help.ubuntu.com
     * Management:     https://landscape.canonical.com
     * Support:        https://ubuntu.com/advantage
    
    0 updates can be applied immediately.
    
    
    The programs included with the Ubuntu system are free software;
    the exact distribution terms for each program are described in the
    individual files in /usr/share/doc/*/copyright.
    
    Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
    applicable law.

Первое, что необходимо нам с вами сделать, это получить все доступные обновления. Выполняем команду:

    apt update && apt upgrade

Выполнение команды займет какое-то время и, возможно, потребует каких-то ваших подтверждений.

Далее, надо создать нового пользователя, потому что ходить по серверу под рутом (**root** - главный администратор сервера) считается не очень безопасно. Безопаснее взаимодействовать с сервером от имени пользователя с ограниченными правами, но с возможностью получить **root**\-права временно, при необходимости. Замените **mike** на имя, под которым вы, в дальнейшем, планируете подключаться к удаленному серверу, и выполните команду

    useradd -m -s /bin/bash -G sudo mike

Тут некоторые пояснения:

*   Флаг `-m` создает домашний каталог, то есть в директории **home** появится директория **mike**
*   Флаг `-s` и путь до оболочки устанавливает для пользователя оболочку, которая будет доступна по умолчанию. Установим **bash**
*   Флаг `-G` позволяет сообщить системе в каких группах будет состоять пользователь. На данном этапе добавляем пользователя в группу **sudo**, чтобы у него была возможность выполнять команды в системе с правами **root**\-пользователя

Далее, нужно задать пароль пользователю для входа от имени администратора. То есть, когда какую-то операцию на сервере нужно будет выполнить с правами **root**\-пользователя через **sudo** - сервер будет запрашивать пароль. Советую его запомнить, иначе после того, как мы отключим возможность подключаться к серверу через **root**, можно будет потерять доступ к правам **root**\-пользователя, если, вдруг забыть или потерять пароль. Придется переустанавливать и заново настраивать систему. Замените **mike** на имя вашего пользователя.

    passwd mike

Появится приглашение, где надо будет ввести пароль.

    root@my-server-for-bot:/home/mike# passwd mike
    New password: 

Вводим пароль, подтверждаем еще раз и получаем сообщение об успехе:

    root@my-server-for-bot:/home/mike# passwd mike
    New password: 
    Retype new password: 
    passwd: password updated successfully

Устанавливаем брэндмауэр. Для большей безопасности системы лучше ограничить список приложений, которые могут подключаться к серверу извне. Для этого и служит брэндмауэр или по-другому - межсетевой экран.

    apt install ufw

После установки, в любой момент времени, можно посмотреть статус UFW с помощью команды

    sudo ufw status verbose

По умолчанию UFW отключен, поэтому вы увидите, скорее всего такой ответ:

    Status: inactive

По умолчанию брэндмауэр настроен так, что никакие входящие соединения недоступны, а исходящие, наоборот, никак не ограничены. То есть, если сейчас включить брэндмауэр, не разрешив входящие соединения по SSH - можно лишиться доступа к серверу. А оно нам надо? Посмотреть список приложений, которые доступны для управления через UFW, можно выполнив команду

    ufw app list

У меня отображается следующие:

    Available applications:
      OpenSSH
      iperf

**OpenSSH** - это программа, обслуживающая соединения по протоколу SSH, а **iperf** - это генератор сетевого трафика, предназначенный для проверки скорости и пропускной способности сети. **iperf** нас сейчас не интересует. Поэтому, пока только разрешаем входящие соединения по протоколу SSH

    ufw allow ssh

Получаем разультат:

    Rules updated
    Rules updated (v6)

Запускаем межсетевой экран

    ufw enable

Получаем предупреждение и подтверждаем отправив "y"

    Command may disrupt existing ssh connections. Proceed with operation (y|n)?

Получаем сообщение о том, что брэндмауэр активен.

    Firewall is active and enabled on system startup

Проверяем его состояние

    ufw status

Получаем

    Status: active
    
    To                         Action      From
    --                         ------      ----
    OpenSSH                    ALLOW       Anywhere                  
    OpenSSH (v6)               ALLOW       Anywhere (v6)

Далее нам нужно настроить возможность входить по SSH под юзером, которого создали ранее. Сначала входим в учетную запись нового пользователя. Замените **mike** на имя учетной записи вашего пользователя.

    su - mike

Получаем сообщение и изменение в приглашении в командную строку:

    To run a command as administrator (user "root"), use "sudo <command>".
    See "man sudo_root" for details.
    
    mike@my-server-for-bot:~$

Далее, нужно скопировать SSH-ключи root-пользователя для нового пользователя, чтобы у него также была возможность для входа на сервер по SSH. Сначала создаем папку **.ssh** в директории пользователя.

    mkdir /home/mike/.ssh/

Копируем существующие ключи от **root** для нового пользователя, не забывая заменить **mike** на имя вашей учетки. Так как команда выполняется под **sudo** - нужно будет ввести пароль, который мы установили ранее для нового пользователя.

    sudo cp -r /root/.ssh/authorized_keys /home/mike/.ssh/authorized_keys

С помощью команды `chown` передаем права пользования файлом ssh-ключа пользователю **mike**, чтобы этот пользователь, при подключении по SSH, смог прочитать этот файл. Снова не забываем поменять в команде **mike** на имя вашего пользователя.

    sudo chown mike /home/mike/.ssh/authorized_keys

Теперь давайте отключим возможность подключения к серверу с правами **root**. Но перед этим переподключимся к серверу по SSH с новой учетной записью, чтобы убедиться в том, что мы можем это сделать. А то, если, вдруг, не можем и при этом своими же руками закроем возможность заходить на сервер под рутом - он превратится в кирпич. Ну, или тыкву, кому что ближе. Останется только пересобрать сервер заново, чем, наверное, часто занимаются начинающие сисадмины и девопсы :) Будет у вас примерно вот так.

    mike@MacBook-Air-Mihail-2 ~ % ssh mike@188.124.51.136
    mike@188.124.51.136: Permission denied (publickey).
    mike@MacBook-Air-Mihail-2 ~ % ssh root@188.124.51.136
    root@188.124.51.136: Permission denied (publickey).

Согласитесь, не этого мы с вами, тут, добиваемся.

Итак, закрываем терминал (или вводим команду `exit`), затем снова открываем терминал и вводим команду, не забывая заменить имя пользователя и ip-адрес сервера на ваши данные

    ssh mike@188.124.51.136

Если подключение прошло успешно, то есть мы имеем доступ к серверу не только через **root**, но и через нового пользователя, открываем в редакторе `nano` файл конфигурации службы SSH.

    sudo nano /etc/ssh/sshd_config

В файле, открывшемся в редакторе, нужно найти строку `PermitRootLogin yes` и заменить `yes` на `no`

![](https://ucarecdn.com/9ca9a264-2958-4111-a2e4-6885718b32f7/-/preview/-/enhance/78/)

И точно также нужно `yes` заменить на `no` для параметра `PasswordAuthentication`

![](https://ucarecdn.com/75b398a2-4297-44e8-bec8-1bb2510cebff/-/preview/-/enhance/81/)

Нажимаем **Ctrl+X**, чтобы сохранить изменения. Нужно будет нажать сначала **y**, а затем **Enter**. После выхода из редактора необходимо перезапустить службу **ssh**, чтобы изменения вступили в силу. Для этого выполняем команду:

    sudo service ssh restart

Ну, и в завершение этого шага, можно еще проверить версию python, которая уже установлена в системе, выполнив команду

    python3 -V

Мой сервер ответил так:

    Python 3.10.6

Отлично! Для текущих задач нам вполне хватит!

Первые предварительные настройки сервера произведены. Давайте теперь подготовим самого бота к переселению.