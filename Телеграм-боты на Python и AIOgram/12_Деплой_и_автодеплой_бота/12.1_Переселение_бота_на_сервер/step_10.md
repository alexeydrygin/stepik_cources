## Systemd
-------

Существуют разные подходы к тому, чтобы сохранять сессию с запущенным ботом активной, после завершения SSH соединения с сервером. Если интересно про них почитать - можно гуглить ключевики _screen_, _timux_, _nohup_ и т.п. Но, если честно, все время заходить на сервер и запускать бота вручную, хоть и надо уметь, но, думаю, это не самое интересное занятие. Можно просто автоматизировать запуск бота, чтобы он запускался при загрузке сервера, а также перезапускался в случае своего падения.

Есть такая штука - **systemd**. Это подсистема инициализации и управления службами в Linux, с помощью которой можно настроить поведение разных процессов в системе. Очень мощный инструмент с кучей возможностей и настроек. Но нас с вами, на текущий момент, интересует включение/выключение сервисов по событиям. Если кратко - **systemd** запускает сервисы, описанные в его конфигурации, а конфигурация состоит из множества текстовых файлов, которые называют юнитами.

Каждый юнит состоит из названия секции в квадратных скобках и пар "Переменная = значение". Например, юнит может выглядеть так:

    [Unit]
    Description=MyUnit
    After=syslog.target
    After=network.target
    After=nginx.service
    After=mysql.service
    Requires=mysql.service
    Wants=redis.service
    
    [Service]
    Type=forking
    PIDFile=/work/www/myunit/shared/tmp/pids/service.pid
    WorkingDirectory=/work/www/myunit/current
    
    User=myunit
    Group=myunit
    
    Environment=RACK_ENV=production
    
    OOMScoreAdjust=-1000
    
    ExecStart=/usr/local/bin/bundle exec service -C /work/www/myunit/shared/config/service.rb --daemon
    ExecStop=/usr/local/bin/bundle exec service -S /work/www/myunit/shared/tmp/pids/service.state stop
    ExecReload=/usr/local/bin/bundle exec service -S /work/www/myunit/shared/tmp/pids/service.state restart
    TimeoutSec=300
    
    [Install]
    WantedBy=multi-user.target

Сейчас не надо разбираться, что в нем написано, это просто пример, чтобы вы понимали как юнит может выглядеть. В простом случае в юните должно быть три секции:

*   `[Unit]`
*   `[Service]`
*   `[Install]`

В секцию `[Unit]` помещают описание, что это за юнит, порядок запуска сервисов, требуемые запущенные сервисы, желательно запущенные сервисы и так далее. На основании этого блока **systemd** принимает решение, когда выполнить данный юнит.

Секция `[Service]`  содержит информацию о том какими командами и под каким пользователем запускать нужный процесс, какой каталог считать текущим для запуска команд, переменные окружения, команды на остановку и перезапуск сервиса, полный путь к исполняемому файлу и так далее.

А в секцию  `[Install]` помещают уровень запуска сервиса.

Понимаю, что много вопросов и многое непонятно. Но у нас с вами нет сейчас необходимости разобраться в тонкостях **systemd**. Мы будем использовать готовый скрипт, который решит нашу задачу. И хотя я сторонник того, что нужно хотя бы в общих чертах представлять, что происходит на всех уровнях работы программ, в данном случае, подробности, можно опустить, потому что можно сильно уйти в сторону.

Итак. Что нужно сделать. Заходим на удаленный сервер по SSH, если вы не подключены. Напоминаю команду.

    ssh <имя_пользователя>@<ip_адрес_сервера>

Переходим в директорию `/etc/systemd/system/`

    cd /etc/systemd/system/

Запускаем с правами рута редактор текста **nano**, ну или тот, которым вы привыкли пользоваться. Название редактируемого файла может быть любым, например, по имени бота. В моем случае это `FSM_example_bot`. Расширение редактируемого файла при этом должно быть `.service`

    sudo nano FSM_example_bot.service

Вставляем в редакторе следующие строки:

    [Unit]
    Description=<название_сервиса>
    After=syslog.target
    After=network.target
    
    [Service]
    Type=simple
    User=<имя_пользователя>
    WorkingDirectory=<путь_к_директории_с_ботом>
    ExecStart=<путь_к_интерпретатору_python_в_виртуальном_окружении> <путь_к_исполняемому_файлу_бота>
    Restart=always
    
    [Install]
    WantedBy=multi-user.target

Соответственно, все, что в угловых скобочках, включая и сами скобочки, нужно заменить вашими данными. В качестве примера, для моего бота файл `FSM_example_bot.service` будет выглядеть так:

    [Unit]
    Description=FSM_example_bot
    After=syslog.target
    After=network.target
    
    [Service]
    Type=simple
    User=mike
    WorkingDirectory=/home/mike/FSM_example_bot
    ExecStart=/home/mike/FSM_example_bot/venv/bin/python3 /home/mike/FSM_example_bot/bot.py
    Restart=always
    
    [Install]
    WantedBy=multi-user.target

Заполнили файл. Выходим из редактора **nano**, нажав **Ctrl+X.** Подтверждаем сохранение файла, нажав **y** и затем **Enter**.

Теперь, чтобы **systemd** увидел новый юнит, его нужно перезапустить. **Systemd** перезапустить, в смысле. Не юнит. Выполняем команду:

    sudo systemctl daemon-reload

А затем запускаем только что созданный юнит командами:

    sudo systemctl enable FSM_example_bot
    sudo systemctl start FSM_example_bot

На этом этапе, если не возникло каких-то непредвиденных ситуаций, можно проверить как бот работает, отправив ему команду /start. А затем можно отключиться от сервера, чтобы убедиться в том, что бот продолжает работать. Кажется, наконец-то наш бот не только обрел новый домик, но и поддерживает свою жизнеспособность в автоматическом режиме!

**Примечание 1**. Чтобы посмотреть статус сервиса (в нашем случае сервис - это наш бот) можно выполнить команду на удаленном сервере:

    sudo systemctl status FSM_example_bot

У меня результат ее работы такой:

![](https://ucarecdn.com/fd056104-70d0-4998-9367-f5c8cb20b081/-/preview/-/enhance/80/)

Обратите внимание на зеленую надпись **active (running)** - она сообщает, что сервис запущен и работает.

Чтобы потом опять попасть в командную строку - нужно набрать

    :q

**Примечание 2**. Чтобы вручную перезапустить юнит - надо выполнить команду:

    sudo systemctl restart FSM_example_bot

**Примечание 3**. Чтобы остановить работу юнита - нужно выполнить команду:

    sudo systemctl stop FSM_example_bot

**Примечание 4**. Чтобы совсем отключить выполнение юнита - нужно выполнить команду:

    sudo systemctl disable FSM_example_bot

**Примечание 5**. Чуть более подробно про **systemd** можно почитать в [статье](https://habr.com/ru/company/southbridge/blog/255845/) на Хабре, там все изложено довольно простым языком - общее представление составить можно.